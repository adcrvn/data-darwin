name: Deploy

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-2
  ECR_REPOSITORY: smarthome-radar-api
  ASG_NAME: smarthome-radar-asg

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    permissions:
      id-token: write   # Required for OIDC
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::802738533039:role/smarthome-radar-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Wait for any in-progress instance refresh
        run: |
          echo "Checking for in-progress instance refresh..."
          while true; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name $ASG_NAME \
              --query 'InstanceRefreshes[0].Status' \
              --output text 2>/dev/null || echo "None")

            if [[ "$STATUS" == "Pending" || "$STATUS" == "InProgress" ]]; then
              echo "Instance refresh in progress (status: $STATUS). Waiting 30s..."
              sleep 30
            else
              echo "No in-progress instance refresh (status: $STATUS)"
              break
            fi
          done

      - name: Trigger ASG instance refresh
        run: |
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name $ASG_NAME \
            --preferences '{"MinHealthyPercentage": 0}' \
            --query 'InstanceRefreshId' \
            --output text)
          echo "Instance refresh started: $REFRESH_ID"
          echo "Monitor at: https://console.aws.amazon.com/ec2/autoscaling/home?region=$AWS_REGION#/details/$ASG_NAME?view=instanceRefresh"
